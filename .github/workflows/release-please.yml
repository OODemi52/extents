name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please.json
          manifest-file: .release-please-manifest.json

  compose-release-notes:
    name: Compose Release Notes
    needs: [release-please, build]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compose Release Notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          sleep 15

          RELEASE_DATA=$(gh release view "$TAG_NAME" --json assets,body)
          ASSETS=$(echo "$RELEASE_DATA" | jq '.assets')
          CHANGELOG=$(echo "$RELEASE_DATA" | jq -r '.body')

          asset_url() {
            local name="$1"
            if echo "$ASSETS" | jq -e --arg name "$name" 'any(.name == $name)' >/dev/null; then
              echo "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${name}"
            fi
          }

          add_row() {
            local platform="$1"
            local kind="$2"
            local asset="$3"
            local url
            url=$(asset_url "$asset")
            if [ -n "$url" ]; then
              ROWS="${ROWS}    <tr><td>${platform}</td><td>${kind}</td><td><a href=\"${url}\">download</a></td></tr>"$'\n'
            fi
          }

          ROWS=""

          add_row "macOS (Apple Silicon)" "DMG" "Extents-macos-arm64-${TAG_NAME}.dmg"
          add_row "macOS (Intel)" "DMG" "Extents-macos-x86_64-${TAG_NAME}.dmg"
          add_row "Windows (x64)" "Installer (EXE)" "Extents-windows-x86_64-${TAG_NAME}.exe"
          add_row "Windows (x64)" "MSI Installer" "Extents-windows-x86_64-${TAG_NAME}.msi"

          add_row "Linux (x86_64)" "AppImage" "Extents-linux-x86_64-${TAG_NAME}.AppImage"
          add_row "Linux (x86_64)" "deb" "Extents-linux-x86_64-${TAG_NAME}.deb"
          add_row "Linux (x86_64)" "rpm" "Extents-linux-x86_64-${TAG_NAME}.rpm"

          add_row "Linux (ARM64)" "AppImage" "Extents-linux-aarch64-${TAG_NAME}.AppImage"
          add_row "Linux (ARM64)" "deb" "Extents-linux-aarch64-${TAG_NAME}.deb"
          add_row "Linux (ARM64)" "rpm" "Extents-linux-aarch64-${TAG_NAME}.rpm"

          TEMPLATE=$(cat .github/RELEASE_TEMPLATE/release.md)
          VERSION_SUBST_TEMPLATE="${TEMPLATE//\$\{version\}/$TAG_NAME}"
          ASSET_TABLE_SUBST_TEMPLATE="${VERSION_SUBST_TEMPLATE//\$\{asset_table\}/$ROWS}"

          FINAL_BODY=$(echo -e "$ASSET_TABLE_SUBST_TEMPLATE\n\n$CHANGELOG")

          gh release edit "$TAG_NAME" --notes "$FINAL_BODY"

  build:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macos-arm64
            runner: macos-latest
            target: aarch64-apple-darwin
            bundles: dmg
            artifact_os: macos
            artifact_arch: arm64
            expected_exts: dmg
          - name: macos-x86_64
            runner: macos-latest
            target: x86_64-apple-darwin
            bundles: dmg
            artifact_os: macos
            artifact_arch: x86_64
            expected_exts: dmg
          - name: windows-x86_64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            bundles: msi,nsis
            artifact_os: windows
            artifact_arch: x86_64
            expected_exts: msi exe
          - name: linux-x86_64
            runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bundles: appimage,deb,rpm
            artifact_os: linux
            artifact_arch: x86_64
            expected_exts: AppImage deb rpm
          # Use GitHub-hosted ARM runners to avoid AppImage cross-compilation limitations.
          - name: linux-aarch64
            runner: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            bundles: appimage,deb,rpm
            artifact_os: linux
            artifact_arch: aarch64
            expected_exts: AppImage deb rpm
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log build target
        run: echo "Building ${{ matrix.name }} on ${{ matrix.runner }} (${{ matrix.target }})"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: startsWith(matrix.runner, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            xdg-utils

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ needs.release-please.outputs.tag_name }}
          releaseName: Extents - ${{ needs.release-please.outputs.tag_name }}
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.target }} --bundles ${{ matrix.bundles }}
          assetNamePattern: Extents-${{ matrix.artifact_os }}-${{ matrix.artifact_arch }}-${{ needs.release-please.outputs.tag_name }}[ext]

      - name: Verify bundle outputs
        shell: bash
        env:
          BUNDLE_DIR: src-tauri/target/${{ matrix.target }}/release/bundle
          EXPECTED_EXTS: ${{ matrix.expected_exts }}
        run: |
          set -euo pipefail
          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "Bundle directory not found: $BUNDLE_DIR"
            exit 1
          fi
          missing=0
          for ext in $EXPECTED_EXTS; do
            if ! find "$BUNDLE_DIR" -type f -iname "*.${ext}" -print -quit | grep -q .; then
              echo "Missing *.$ext bundle in $BUNDLE_DIR"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Extents-${{ matrix.artifact_os }}-${{ matrix.artifact_arch }}-${{ needs.release-please.outputs.tag_name }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.rpm

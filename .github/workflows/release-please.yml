name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please.json
          manifest-file: .release-please-manifest.json

  compose-release-notes:
    name: Compose Release Notes
    needs: [release-please, build]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compose Release Notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          sleep 15

          RELEASE_DATA=$(gh release view "$TAG_NAME" --json assets,body)
          ASSETS=$(echo "$RELEASE_DATA" | jq '.assets')
          CHANGELOG=$(echo "$RELEASE_DATA" | jq -r '.body')

          TABLE="| Platform | Package Type | Download |\n|---|---|---|\n"

          NSIS_URL=$(echo "$ASSETS" | jq -r 'map(select(.name | endswith("-setup.exe"))) | .[0].url')
          if [ "$NSIS_URL" != "null" ]; then
            TABLE="${TABLE}| Windows (x64) | Installer | [exe]($NSIS_URL) |\n"
          fi

          MSI_URL=$(echo "$ASSETS" | jq -r 'map(select(.name | endswith(".msi"))) | .[0].url')
          if [ "$MSI_URL" != "null" ]; then
            TABLE="${TABLE}| Windows (x64) | MSI Installer | [msi]($MSI_URL) |\n"
          fi

          UNIVERSAL_DMG_URL=$(echo "$ASSETS" | jq -r 'map(select(.name | endswith("_universal.dmg"))) | .[0].url')
          if [ "$UNIVERSAL_DMG_URL" != "null" ]; then
            TABLE="${TABLE}| macOS | Universal | [dmg]($UNIVERSAL_DMG_URL) |\n"
          fi

          APPIMAGE_URL=$(echo "$ASSETS" | jq -r 'map(select(.name | test("\\.appimage$"; "i"))) | .[0].url')
          if [ "$APPIMAGE_URL" != "null" ]; then
            TABLE="${TABLE}| Linux | AppImage | [AppImage]($APPIMAGE_URL) |\n"
          fi

          DEB_URL=$(echo "$ASSETS" | jq -r 'map(select(.name | endswith(".deb"))) | .[0].url')
          if [ "$DEB_URL" != "null" ]; then
              TABLE="${TABLE}| Linux (Debian/Ubuntu) | Package | [deb]($DEB_URL) |\n"
          fi

          RPM_URL=$(echo "$ASSETS" | jq -r 'map(select(.name | endswith(".rpm"))) | .[0].url')
          if [ "$RPM_URL" != "null" ]; then
            TABLE="${TABLE}| Linux (Fedora/CentOS) | Package | [rpm]($RPM_URL) |\n"
          fi

          TEMPLATE=$(cat .github/RELEASE_TEMPLATE/release.md)
          VERSION_SUBST_TEMPLATE="${TEMPLATE//\$\{version\}/$TAG_NAME}"
          ASSET_TABLE_SUBST_TEMPLATE="${VERSION_SUBST_TEMPLATE//\$\{asset_table\}/$TABLE}"

          FINAL_BODY=$(echo -e "$ASSET_TABLE_SUBST_TEMPLATE\n\n$CHANGELOG")

          gh release edit "$TAG_NAME" --notes "$FINAL_BODY"

  build:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ needs.release-please.outputs.tag_name }}
          releaseName: "Extents ${{ needs.release-please.outputs.tag_name }}"
          releaseDraft: false
          prerelease: false
